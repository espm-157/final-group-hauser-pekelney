---
title: "fire.Rmd"
author: "Rachel Pekelney & Joshua Hauser"
date: "11/28/2021"
output: html_document
---

```{r options, include= FALSE, warning = FALSE}
library(tmap)      #interactive maps, raster + vector layers
library(terra)       # Successor to the raster library
library(tidyverse)   # our old friend
library(sf)   # to work with simple features (vector) data
library(rosm) # to work with OSM data
library(prettymapr)
library(yaps)
library(rgdal)
library(raster)
```  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fire perimeters in the ICB
https://frap.fire.ca.gov/frap-projects/fire-perimeters/

```{r, results='hide}
dir.create("../data/fireperimeters")
download.file("https://frap.fire.ca.gov/media/50dgwqrb/fire20_1.zip", "../data/fireperimeters/fire20_1.zip")
unzip("../data/fireperimeters/fire20_1.zip", 
      exdir = "../data/fireperimeters/fireperimeters")
```

```{r}
#can filter by NPS and YNP easily I think. I think to get the ICB fires though we should just manually select them out of the table from "FIRE_NAME"
fireperimeters_nad83 = st_read("../data/fireperimeters/fireperimeters/fire20_1.gdb")

# re-project to same CRS as Landsat imagery: WGS 84 / UTM Zone 10N
# load Landsat raster first to have CRS available for reference
landsat_raster_b4 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B4.TIF")

fireperimeters = st_transform(fireperimeters_nad83, crs(landsat_raster_b4))
```

```{r}
# will need to re-project fire perimeters to different CRS: WGS 84 / UTM Zone 10N
icb_fires = as.tibble(fireperimeters) %>%
  filter(UNIT_ID == "YNP") %>%
  filter(YEAR_ > 1971) %>%
  arrange(YEAR_)
icb_fires
```

```{r}
dir.create("../data/YosemiteVeg")
download.file("https://irma.nps.gov/DataStore/DownloadFile/599215", "../data/YosemiteVeg/599215")
unzip("../data/YosemiteVeg/599215", 
      exdir = "../data/YosemiteVeg/")

```

```{r}
# SomethinginYos = rast('../data/YosemiteVeg/yosegeodata/YOSE_VegPolys.lyr')
tm_shape("../data/YosemiteVeg/yosegeodata/YOSE_VegPolys.lyr") + tm_polygons()
```

```{r, , results=hide}
# unzipping boundary for Yosemite National Park

dir.create("../data/yosemiteboundary")
download.file("https://irma.nps.gov/DataStore/DownloadFile/427871", "../data/yosemiteboundary/Yose_Boundary.zip")
unzip("../data/yosemiteboundary/Yose_Boundary.zip", 
      exdir = "../data/yosemiteboundary/yosemiteboundary")

yos_bound_nad83 = st_read("../data/yosemiteboundary/yosemiteboundary")

# re-project to same CRS as Landsat imagery: WGS 84 / UTM Zone 10N
yos_bound = st_transform(yos_bound_nad83, crs(landsat_raster_b4))
```

```{r}
# Landsat rasters for 9/15/21
landsat_raster_b4 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B4.TIF")
landsat_raster_b5 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B5.TIF")

# projected so everything is in WGS 84 / UTM Zone 10N
icb_shp_nad83 <- st_read("ill_wtrshd_nad83.shp")
icb_shp <- st_transform(icb_shp_nad83, crs(landsat_raster_b4))
# confirming that it successfully re-projected 
st_crs(icb_shp)

band_list <- c(landsat_raster_b4, landsat_raster_b5)

# b4b5 <- stack(band_list)

# for Landsat 8 [B4 = Red and B5 = NIR]
# NDVI = (NIR - Red) / (NIR + Red)
landsat_ndvi <- (landsat_raster_b5 - landsat_raster_b4) / (landsat_raster_b5 + landsat_raster_b4)

icb_bbox <- st_bbox(c(xmin = 263981.057935, xmax = 289328.931675, ymax = 4181703.867149, ymin = 4159160.072076))

# plot the data
tm_shape(landsat_ndvi, bbox = st_bbox(icb_shp)) + tm_raster(midpoint = NA) + tm_shape(icb_shp) + tm_polygons(alpha=0)

```

```{r}
# Landsat rasters for 9/16/1972
landsat72_raster_b5 <- rast("LM01_L1TP_045034_19720916_20200909_02_T2_B5.TIF")
landsat72_raster_b7 <- rast("LM01_L1TP_045034_19720916_20200909_02_T2_B7.TIF")

band_list72 <- c(landsat_raster_b4, landsat_raster_b5)

# for Landsat 1-3 [B5 = red and B7 = NIR] 
# NDVI = (NIR - Red) / (NIR + Red)
landsat_ndvi72 <- (landsat72_raster_b7 - landsat72_raster_b5) / (landsat72_raster_b7 + landsat72_raster_b5)

# plot the data
tm_shape(landsat_ndvi72, bbox = st_bbox(icb_shp)) + tm_raster(midpoint = NA) + tm_shape(icb_shp) + tm_polygons(alpha=0)

```
Fire Perimeters Mapped onto true color Landsat basemap
```{r}
landsat_refl_21 = rast("LC08_L1TP_042034_20210915_20210925_02_T1_refl.tif")
rgb = brick(landsat_refl_21)
rgb_stack = stack(rgb)

cropped = crop(rgb_stack, yos_bound)

tm_shape(cropped, bbox = st_bbox(yos_bound)) + tm_raster() +
  tm_shape(fireperimeters) + tm_polygons(alpha = 0.1)

```


```{r}
# NAIP raster
naip_raster <- rast('m_3711920_se_11_060_20200804.jp2')

#trying NDVI calculation
naip_multispectral_st <- stack(naip_raster)
naip_multispectral_br <- brick(naip_multispectral_st)

naip_ndvi <- (naip_multispectral_br[[4]] - naip_multispectral_br[[1]]) / (naip_multispectral_br[[4]] + naip_multispectral_br[[1]])

# plot the data
plot(naip_ndvi,
     main = "NDVI of Illilouette Creek Basin",
     axes = FALSE, box = FALSE)

```


Landsat 1-3 
Band 5 = red
Band 7 = NIR
date 9/16/1972

Landsat 8
Band 4 = red
Band 5 = NIR
date 9/15/2021
