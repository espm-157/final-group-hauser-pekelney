---
title: "fire.Rmd"
author: "Rachel Pekelney & Joshua Hauser"
date: "11/28/2021"
output: html_document
---

```{r options, include= FALSE, warning = FALSE}
library(tmap)      #interactive maps, raster + vector layers
library(terra)       # Successor to the raster library
library(tidyverse)   # our old friend
library(sf)   # to work with simple features (vector) data
library(rosm) # to work with OSM data
library(prettymapr)
library(yaps)
library(rgdal)
library(raster)

```  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# NDVI in the Illilouette Creek Basin: examining changes after the introduction of managed wildfire

## Introduction




## Fire perimeters in the ICB
https://frap.fire.ca.gov/frap-projects/fire-perimeters/

```{r, results= 'hide', message=FALSE, warning=FALSE}
dir.create("../data/fireperimeters")
download.file("https://frap.fire.ca.gov/media/50dgwqrb/fire20_1.zip", "../data/fireperimeters/fire20_1.zip")
unzip("../data/fireperimeters/fire20_1.zip", 
      exdir = "../data/fireperimeters/fireperimeters")
```

```{r, message=FALSE, warning=FALSE}
# can filter by NPS and YNP to get fires in Yosemite
fireperimeters_nad83 = st_read("../data/fireperimeters/fireperimeters/fire20_1.gdb", layer = "firep20_1")

# load Landsat raster first to have CRS available for reference
landsat_raster_b4 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B4.TIF")

# re-project fire perimeters to same CRS as Landsat imagery: WGS 84 / UTM Zone 10N
fireperimeters = st_transform(fireperimeters_nad83, crs(landsat_raster_b4))
```

```{r}
fireperimetersCA = as_tibble(fireperimeters) 

# fire perimeters in Yosemite, post-1972 only
yos_fires_post72 = fireperimetersCA %>%
  filter(UNIT_ID == "YNP") %>%
  filter(YEAR_ > 1971) %>%
  arrange(YEAR_)

# fire perimeters in Yosemite, all historical data
yos_fires = fireperimetersCA %>%
  filter(UNIT_ID == "YNP") %>%
  arrange(YEAR_)

# plotting number of fires per year since earliest data recorded
yos_fires %>% 
  group_by(YEAR_) %>% 
  summarise(n=n()) %>%
  mutate(YEAR_, Year = as.numeric(YEAR_)) %>% 
  ggplot(aes(x=Year, y=n)) + geom_col(fill="red", alpha=0.5) +
  labs(y = "Number of Fires", title = "Number of fires annually in Yosemite Nat'l Park (1933-2020)") +
  geom_vline(aes(xintercept=1972), color="purple", linetype="dotted")

# purple dotted line falls at year 1972, the beginning of the managed wildfire period
```


```{r, results=hide, message=FALSE, warning=FALSE}
# unzipping boundary for Yosemite National Park

dir.create("../data/yosemiteboundary")
download.file("https://irma.nps.gov/DataStore/DownloadFile/427871", "../data/yosemiteboundary/Yose_Boundary.zip")
unzip("../data/yosemiteboundary/Yose_Boundary.zip", 
      exdir = "../data/yosemiteboundary/yosemiteboundary")

yos_bound_nad83 = st_read("../data/yosemiteboundary/yosemiteboundary")

# re-project to same CRS as Landsat imagery: WGS 84 / UTM Zone 10N
yos_bound = st_transform(yos_bound_nad83, crs(landsat_raster_b4))
```

```{r}
# Landsat rasters for 9/15/21
landsat_raster_b4 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B4.TIF")
landsat_raster_b5 <- rast("LC08_L1TP_042034_20210915_20210925_02_T1_B5.TIF")

# projected so everything is in WGS 84 / UTM Zone 10N
icb_shp_nad83 <- st_read("ill_wtrshd_nad83.shp")
icb_shp <- st_transform(icb_shp_nad83, crs(landsat_raster_b4))
# confirming that it successfully re-projected 
st_crs(icb_shp)

# for Landsat 8 [B4 = Red and B5 = NIR]
# NDVI = (NIR - Red) / (NIR + Red)
landsat_ndvi <- (landsat_raster_b5 - landsat_raster_b4) / (landsat_raster_b5 + landsat_raster_b4)

# plot the data
tm_shape(landsat_ndvi, bbox = st_bbox(icb_shp)) + tm_raster(midpoint = 0, title="NDVI Index Value") + 
  tm_shape(icb_shp) + tm_polygons(alpha=0) +
  tm_compass(size=1) + tm_scale_bar() + 
  tm_layout(main.title="NDVI in ICB (2021)", legend.outside = TRUE)

```

```{r}
# Landsat rasters for 9/16/1972
landsat72_raster_b5 <- rast("LM01_L1TP_045034_19720916_20200909_02_T2_B5.TIF")
landsat72_raster_b7 <- rast("LM01_L1TP_045034_19720916_20200909_02_T2_B7.TIF")

# for Landsat 1-3 [B5 = red and B7 = NIR] 
# NDVI = (NIR - Red) / (NIR + Red)
landsat_ndvi72 <- (landsat72_raster_b7 - landsat72_raster_b5) / (landsat72_raster_b7 + landsat72_raster_b5)

# plot the data
tm_shape(landsat_ndvi72, bbox = st_bbox(icb_shp), title="NDVI") + tm_raster(midpoint = 0, title="NDVI Index Value") + 
  tm_shape(icb_shp) + tm_polygons(alpha=0) +
  tm_compass(size=1) + tm_scale_bar() + 
  tm_layout(main.title="NDVI in ICB (1972)", legend.outside = TRUE)

```

```{r}
# adjusting for different resolution in Landsat data from 1972 and 2021
resampled_ndvi21 <- resample(landsat_ndvi, landsat_ndvi72, method = "bilinear")

tm_shape(resampled_ndvi21, bbox = st_bbox(icb_shp)) + tm_raster(midpoint = 0, title="NDVI Index Value") + 
  tm_shape(icb_shp) + tm_polygons(alpha=0) +
  tm_layout(main.title="NDVI in ICB (2021)", legend.outside = TRUE) +
  tm_compass(size=1) + tm_scale_bar() + 
  tm_credits("resampled to 60x60m resolution", position=c("RIGHT", "BOTTOM"))

```


```{r, message=FALSE, warning=FALSE}
# cropping NDVI rasters to ICB boundary
cropped21_rs = crop(resampled_ndvi21, icb_shp)
cropped21 = crop(landsat_ndvi, icb_shp)
cropped72 = crop(landsat_ndvi72, icb_shp)

# histogram of NDVI 2021 (resampled)
hist((cropped21_rs),
  main = "NDVI: Distribution of pixels\n Illilouette Creek Basin 2021",
  col = "orange",
  xlab = "NDVI Index Value")

# histogram of NDVI 1972
hist((cropped72),
  main = "NDVI: Distribution of pixels\n Illilouette Creek Basin 1972",
  col = "blue",
  add = T, 
  xlab = "NDVI Index Value")

# overlay histograms with ggplot
df_21 = as.data.frame(cropped21_rs) 
df_72 = as.data.frame(cropped72) 

ggplot() + 
  geom_histogram(data=df_21, 
                 aes(x=LC08_L1TP_042034_20210915_20210925_02_T1_B5, fill=LC08_L1TP_042034_20210915_20210925_02_T1_B5),
                 fill="blue",
                 color="blue") + 
  geom_histogram(data=df_72, 
                 aes(x=LM01_L1TP_045034_19720916_20200909_02_T2_B7, fill=LM01_L1TP_045034_19720916_20200909_02_T2_B7), 
                 fill="yellow",
                 color="yellow",
                 alpha = .8) + 
  ggtitle("Distribution of NDVI values in the ICB: 2021 (blue) vs 1972 (yellow)") +
  labs(x = "NDVI Index Value", y = "Frequency", subtitle = "Landsat rasters 60x60m resolution")

```

```{r}
# charting distributions of NDVI without resampling raster resolution

df21 = as.data.frame(cropped21) %>%
  mutate(range = cut(LC08_L1TP_042034_20210915_20210925_02_T1_B5, c(-1, -.9, -.8, -.7, -.6, -.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1))) %>%
  group_by(range) %>%
  summarise(n=n()) %>%
  mutate(percent = 100 * n/(531* 590))

df72 = as.data.frame(cropped72) %>%
  mutate(range = cut(LM01_L1TP_045034_19720916_20200909_02_T2_B7, c(-1, -.9, -.8, -.7, -.6, -.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1))) %>%
  group_by(range) %>%
  summarise(n=n()) %>%
  mutate(percent = 100 * n/(265*295))

colors = c("1972" = "yellow", "2021" = "blue")

ggplot() + 
geom_col(data=df21, aes(x=range, y=percent), fill='blue', color = "blue") + 
geom_col(data=df72, aes(x=range, y=percent), fill='yellow', color = "yellow", alpha = .8) + ggtitle("Distribution of NDVI values in the ICB: 2021 (blue) and 1972 (yellow)")
```

## Fire Perimeters Mapped onto true color Landsat basemap
```{r, message=FALSE}
landsat_refl_21 = rast("LC08_L1TP_042034_20210915_20210925_02_T1_refl.tif")
rgb = brick(landsat_refl_21)
rgb_stack = stack(rgb)

cropped = crop(rgb, yos_bound)

fire_shp = st_read("California_Wildland_Fire_Perimeters_(All)/California_Wildland_Fire_Perimeters_(All).shp")
fire_shp_reproj = st_transform(fire_shp, crs(landsat_raster_b4))

keep <- st_is_valid(fire_shp_reproj)

tm_shape(cropped, bbox = st_bbox(yos_bound)) + tm_rgb() +
  fire_shp_reproj %>% filter(keep) %>% tm_shape(name="Fire Perimeters", bbox = st_bbox(yos_bound)) + tm_polygons(col = "yellow", border.col = "red", alpha = 0.1, lwd = 1) + 
  tm_shape(yos_bound, name="Yosemite Nat'l Park") + tm_polygons(border.col = "blue",  alpha = 0) + 
  tm_shape(icb_shp, name="ICB") + tm_polygons(border.col = "white",  alpha = 0) +
  tm_compass(size=1) + tm_scale_bar(size=0.3) + 
  tm_layout(legend.outside=TRUE, 
            main.title="Fire Perimeters in Yosemite National Park",
            legend.text.size = 0.5,
            legend.position = c("left", "bottom"))

```


```{r, message=FALSE, warning=FALSE}
# NAIP raster
naip_raster <- rast('m_3711920_se_11_060_20200804.jp2')

#trying NDVI calculation
naip_multispectral_st <- stack(naip_raster)
naip_multispectral_br <- brick(naip_multispectral_st)

naip_ndvi <- (naip_multispectral_br[[4]] - naip_multispectral_br[[1]]) / (naip_multispectral_br[[4]] + naip_multispectral_br[[1]])

# plot the data
plot(cropped_naip,
     main = "NDVI of Illilouette Creek Basin",
     axes = FALSE, box = FALSE)

```

## Sources

### Fire Perimeters: 
[CAL FIRE Fire Perimeters](https://data.ca.gov/dataset/fire-perimeters1) downloaded from the CA State Open Data Portal, updated Dec. 2021 

### ICB Shapefile:
Sourced from [Dr. Brandon M. Collins](https://nature.berkeley.edu/stephenslab/lab-members/dr-brandon-collins/), Berkeley Forests

### Yosemite Nat'l Park Boundary: 
Accessed via the [National Park Service Data Store](https://irma.nps.gov/DataStore/)
[Park boundary updated as of 2006](https://irma.nps.gov/DataStore/Reference/Profile/2170436)

### Landsat Rasters:
Downloaded from the [USGS EarthExplorer](https://earthexplorer.usgs.gov)
  Landsat 1-3 
    Band 5 = red
    Band 7 = NIR
    date: 9/16/1972
  Landsat 8
    Band 4 = red
    Band 5 = NIR
    date: 9/15/2021
    
    
## Papers for Reference

https://escholarship.org/content/qt7c71t4mr/qt7c71t4mr.pdf?t=onishe
https://nature.berkeley.edu/stephenslab/wp-content/uploads/2019/10/Illouette_Creek_Basin_Summary_FINAL.pdf
https://iopscience.iop.org/article/10.1088/2515-7620/ac17e2/pdf 
https://link.springer.com/content/pdf/10.1007/s10021-008-9211-7.pdf


